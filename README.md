# pr-reviewer-assigment-service
```
Киндаров Ибрагим Муслимович
kindarov04@gmail.com
tg: @ibrakadabrs
```

Сервис автоматического назначения ревьюверов на Pull Request’ы.
Реализован на Go в соответствии с OpenAPI-спецификацией (`internal/api/docs/openapi.yml`).
Поднимается командой:

```
docker-compose up --build
```

После запуска сервис доступен по адресу:

* API: [http://localhost:8080](http://localhost:8080)
* Swagger UI: [http://localhost:8080/swagger](http://localhost:8080/swagger)
* Healthcheck: [http://localhost:8080/health](http://localhost:8080/health)

Порт сервиса, параметры подключения к PostgreSQL и окружение задаются в `docker-compose.yml` через локальные переменные (`environment:`).


## Функциональность

### Управление командами

* Создание команды с пользователями - `/team/add`
* Получение команды - `/team/get`
* Деактивировать всех участников команды - `team/deactivate`

### Управление пользователями

* Изменение активности пользователя - `/users/setIsActive`
* Получение списка PR, где пользователь является ревьювером - `/users/getReview`

### Управление Pull Request’ами

* Создание PR и автоматическое назначение 0–2 активных ревьюверов - `/pullRequest/create`
* Идемпотентный merge - `/pullRequest/merge`
* Переназначение ревьювера - `/pullRequest/reassign`

### Статистика

* Получение количество назначений PR по пользователям - `/stats/reviewers`


### Логика, соответствующая заданию

* Автор PR никогда не назначается ревьювером
* Неактивные пользователи не назначаются
* После статуса MERGED список ревьюверов изменять нельзя
* Переназначение выбирает случайного активного участника команды заменяемого ревьювера
* Если доступных кандидатов меньше двух, назначается 0 или 1 ревьювер



## Архитектура (Clean Architecture)

Проект разделён на независимые слои:

```
/cmd                  – точка входа, инициализация сервера
/internal
    /api              – HTTP API слой: хендлеры, DTO, роутер
    /application      – бизнес-логика (services), не зависит от transport/db
        service
        repository     – интерфейсы репозиториев
    /domain           – предметные сущности и доменные ошибки
    /infrastructure   – конкретные реализации репозиториев (Postgres)
/migrations           – SQL миграции для базы данных
```


## Работа с базой данных

Используется PostgreSQL.
Миграции находятся в каталоге `migrations` и применяются автоматически при запуске:

```
docker-compose up
```

Настройки подключения (хост, порт, пользователь, пароль, имя БД) задаются в `docker-compose.yml` в секции `environment:`.


```
go run ./cmd/main.go
```

---

## Swagger UI

Swagger UI встроен в сервис и отображается по адресу:

```
http://localhost:8080/swagger
```

UI использует файл `docs/openapi.yml`.



## Допущения

1. Пользователь всегда относится к команде (требование OpenAPI).
2. Эндпоинт `/team/add` также создаёт или обновляет пользователей. Если пользователь с таким id уже существует - обновляет его информацию.
3. Список ревьюверов хранится в PostgreSQL как `TEXT[]`.
4. Алгоритм выбора ревьюверов - случайный из активных кандидатов.
5. Операция merge полностью идемпотентна.
6. Переназначение генерирует нового ревьювера только из команды заменяемого.


# Нагрузочное тестирование

Для проверки соответствия нефункциональным требованиям был проведён набор нагрузочных тестов с использованием **k6**.

## Цель тестирования

Проверить выполнение SLI:

* **RPS:** ≥ 5
* **Время ответа:** ≤ 300 мс (p95)
* **Успешность запросов:** ≥ 99.9%
* **Объём данных:** до 20 команд и 200 пользователей

## Методика

Использовался сценарий, который имитирует реальные действия сервиса:

* создание Pull Request
* получение списка PR по ревьюверу
* запрос статистики
* health-check

Один виртуальный пользователь выполнял одну итерацию в секунду (`sleep(1)`),
поэтому 5 VUs обеспечивали стабильные **~5 RPS**.

Тест выполнялся 30 секунд.

## Основные результаты (5 RPS)

```
http_reqs......................: ~4.8/s
http_req_failed................: 0.00%
http_req_duration..............: avg=4.8ms  p(95)=11.8ms

create_pr_duration.............: avg=9.8ms   p(95)=12.7ms
get_review_duration............: avg=3.5ms   p(95)=4.4ms
stats_duration.................: avg=3.0ms   p(95)=3.9ms
```

### Вывод:

* Средняя задержка: **3–10 ms**
* p95: **≤ 12 ms**, что в **25 раз быстрее** требуемых 300 ms
* Успешность: **100%**
* Полностью соблюдены SLI по времени ответа, успешности и RPS

## Дополнительный стресс-тест (до 1000 VUs)

Для оценки запаса по производительности был запущен стресс-тест:

```
http_reqs......................: ~968/s
http_req_failed................: 0.00%
http_req_duration..............: avg=3.2ms  p(95)=6ms
```

